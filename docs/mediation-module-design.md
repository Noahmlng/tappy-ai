# Mediation 模块设计文档（M1 执行版）

- 文档版本：v0.4
- 最近更新：2026-02-21
- 文档类型：Execution Design（非路线图）
- 当前范围：Mediation v1 / M1（接入与适配基线）

## 0. 设计元数据（Metadata）

### 0.1 文档目标

本文件用于明确 `Mediation v1` 的基础设计与执行方式，重点回答四件事：
1. 标准接入框架怎么定义。
2. 外部输入到内部统一模型怎么映射。
3. 两类供给源最小适配怎么做，以及回传 Schema 的冲突怎么处理。
4. 最小输入接入指南和最小链路清单怎么执行。

### 0.2 非目标（M1 不覆盖）

1. 完整 SSP 交易层与高级竞价机制。
2. 完整 DSP 策略引擎。
3. 深度用户建模与完整风控体系。

### 0.3 基本前提

1. 当前处于冷启动阶段，外部直接接 DSP/大型 Ads Network 能力有限。
2. M1 先依赖两类供给：广告联盟供给 + 模拟广告库供给。
3. 所有方案以“可接入、可运行、可回退、可扩展”为优先。

## 1. M1 设计总览

M1 采用统一入口的 Mediation 架构：
1. 应用接入层（SDK/BFF）。
2. Mediation 网关层（统一入口）。
3. 标准化与策略层（请求规范化、placement 编排、供给路由）。
4. 供给适配层（联盟适配器 + 模拟库适配器）。
5. 响应组合层（统一响应输出）。
6. 事件回传层（曝光/点击/失败回传）。

设计原则：
1. 单入口：应用只对接 Mediation，不直连多供给源。
2. 单模型：外部多种输入最终落到内部统一模型。
3. 单语义：应用侧只消费统一响应语义。
4. 双链路：请求链路同步返回，事件链路异步回传。

## 2. 标准接入框架（Standard Integration Framework）

### 2.1 框架结构

接入框架由四个接口面构成：
1. `Input Interface`：应用输入面（请求接入面）。
2. `Delivery Interface`：广告返回面（响应输出面）。
3. `Event Interface`：行为回传面（事件上报面）。
4. `Control Interface`：运行控制面（开关、降级、回滚）。

### 2.2 接入方式

M1 统一采用以下方式：
1. 同步请求：应用发起广告评估/请求，Mediation 同步返回标准结果。
2. 异步回传：应用按标准回传行为事件，Mediation 做异步处理与归档。

### 2.3 框架基础要求

1. 版本化：接入协议必须具备版本标识与兼容策略。
2. 幂等性：请求与事件都要支持去重与幂等处理。
3. 解耦性：广告链路异常不阻塞应用核心业务链路（fail-open）。
4. 可观测性：请求与事件必须可在同一追踪上下文中关联。

## 3. 外部输入到内部统一模型的映射规则

## 3.1 外部输入分层

M1 外部输入按五类信息进入系统：
1. 应用与会话信息（应用身份、会话语境）。
2. placement 信息（位置、类型、触发上下文）。
3. 用户与内容上下文（当前交互、内容语义、意图线索）。
4. 策略提示信息（频控提示、安全提示、实验提示）。
5. 追踪与诊断信息（请求追踪、调试信息）。

## 3.2 内部统一模型（概念结构）

内部统一模型固定为六个逻辑块：
1. `RequestMeta`：请求元信息。
2. `PlacementMeta`：广告位元信息。
3. `UserContext`：用户与会话上下文。
4. `OpportunityContext`：机会上下文（场景、意图、任务阶段）。
5. `PolicyContext`：策略上下文（规则、限制、提示）。
6. `TraceContext`：追踪上下文（关联与排查）。

## 3.3 映射规则

1. 先规范化后决策：所有输入必须先映射为统一模型，再进入路由与策略。
2. 必填优先：核心必填块缺失时走可控降级，而非直接崩溃。
3. 枚举统一：外部枚举值先映射到内部标准枚举，未知值归入受控兜底类。
4. 冲突有优先级：同一语义来自多处时，按预定义优先级选择唯一值。
5. 可回放：映射结果必须可复现，便于排查与审计。

## 3.4 映射失败处理

1. 输入不完整：降级为最小可处理请求。
2. 输入不合法：返回标准化错误语义，不泄露内部实现细节。
3. 输入冲突：按优先级规则归一，并记录冲突处理结果。

## 4. 两种供给源最小适配与回传 Schema 处理

## 4.1 两类供给源定义

M1 只包含两类供给源：
1. 联盟供给源（外部广告联盟）。
2. 模拟供给源（模拟广告库）。

## 4.2 最小适配职责

每个供给适配器最小职责一致：
1. 协议适配：把供给源协议转换为内部统一请求。
2. 结果归一：把供给源结果转换为统一候选结构。
3. 状态归一：把错误、空结果、超时统一成平台语义。
4. 追踪透传：保留必要来源标识与诊断信息。

## 4.3 回传 Schema 的核心冲突

你指出的冲突，本质集中在三类：
1. 响应 Schema 与事件回传 Schema 混用，导致语义边界不清。
2. 供给源私有追踪字段与平台统一追踪字段冲突。
3. 供给返回与事件上报时序不一致，导致关联困难。

## 4.4 冲突解决设计（Fundamental Design）

M1 采用“两个 Schema + 一个关联键”的基础设计：
1. `Delivery Schema`：只负责“本次返回内容”。
2. `Event Callback Schema`：只负责“后续行为事件”。
3. `Response Reference`：两个 Schema 共享同一关联引用用于闭环追踪。

约束：
1. Delivery Schema 不承载事件语义。
2. Event Callback Schema 不重复承载完整广告内容快照。
3. 供给私有字段必须先映射为平台标准字段，再选择性保留来源扩展字段。

结果：
1. 边界清晰，减少耦合。
2. 支持后续 SSP 化时扩展回传标准而不破坏主链路。
3. 兼容多供给源并保持统一追踪模型。

## 5. 最小输入接入指南与最小链路清单

## 5.1 最小输入接入指南（M1）

接入方按以下顺序实施：
1. 注册应用与 placement 基础信息。
2. 接入 Mediation 同步请求入口。
3. 完成统一响应渲染与 fail-open 处理。
4. 接入事件异步回传入口。
5. 完成联调与发布前检查。

## 5.2 最小链路清单（M1 Checklist）

### 请求链路（同步）

1. 应用发起请求。
2. Mediation 接收并规范化输入。
3. 映射为内部统一模型。
4. 执行 placement 编排与供给路由。
5. 调用联盟适配器或模拟库适配器。
6. 归一化候选结果。
7. 输出统一响应。
8. 返回应用并完成请求追踪记录。

### 事件链路（异步）

1. 应用侧产生行为事件（曝光/点击/失败）。
2. 按统一回传入口提交事件。
3. Mediation 做事件规范化与关联。
4. 写入事件归档与审计轨迹。
5. 回传处理结果（成功/可重试/不可重试）。

## 5.3 发布前最小联调清单

1. 正常返回链路通过。
2. 空结果链路通过。
3. 超时/异常降级链路通过。
4. 事件回传链路通过。
5. 请求与事件可在同一追踪上下文中关联。
6. 开关、降级、回滚路径已验证。

## 6. M1 交付包（Deliverables）

1. M1 接入框架说明（本设计文档）。
2. 映射规则说明（外部输入 -> 内部模型）。
3. 供给适配说明（联盟 + 模拟库）。
4. 回传 Schema 边界说明（Delivery vs Event Callback）。
5. 最小接入指南与最小链路 checklist。

## 7. 下一轮设计入口

下一轮建议按以下顺序继续：
1. 把“统一模型六个逻辑块”细化为 v1 字段分组（仍先概念分组，不做代码绑定）。
2. 把“两个 Schema + 一个关联键”细化为回传协议草案。
3. 把最小链路清单转为联调用例清单。

## 8. 变更记录

### 2026-02-21（v0.4）

1. 将文档重构为 M1 执行型设计文档（非路线图）。
2. 明确四个核心内容：接入框架、映射规则、两类供给适配、最小接入指南与链路清单。
3. 针对回传 Schema 冲突给出基础解法：`两个 Schema + 一个关联键`。

### 2026-02-21（v0.3）

1. 将 `M1` 从讨论入口升级为“逐条对接约束清单”。
2. 新增 A~H 八组必须约束，覆盖接入关系、供给、placement、请求、响应、事件、运行控制与治理。
3. 新增 `M1` 交付物清单，作为执行落地基线。

### 2026-02-21（v0.2）

1. 新增 `Mediation v1` 最小能力包执行计划。
2. 明确 v1 的 In Scope / Out of Scope。
3. 增加 M1~M4 里程碑、Substeps 与完成定义（DoD）。
4. 增加当前限制因素与下一轮讨论入口。

### 2026-02-21（v0.1）

1. 新建 Mediation 模块专属设计文档。
2. 建立模块使命、边界、能力框架与阶段演进主线。
3. 作为后续 Mediation 深度讨论的主入口文档。
