# Mediation 模块设计文档（当前版本）

- 文档版本：v1.7
- 最近更新：2026-02-21
- 文档类型：Design Doc（策略分析 + 具体设计 + 演进规划）
- 当前焦点：当前版本（接入与适配基线）

## 0. 文档定位（Metadata）

本文件同时承载三层信息：
1. 策略与上下文：为什么现在要这么做。
2. 当前版本具体设计：现在到底怎么做。
3. 未来规划：优化项与 SSP 过渡怎么走。

### 0.1 关联文档

1. AI Assistant Placement Framework：`/Users/zeming/Documents/chat-ads-main/docs/ai-assistant-placement-framework.md`

## 1. 模块使命与边界

### 1.1 模块使命

Mediation 的核心使命：
1. 让 AI 应用低成本、低摩擦接入广告网络。
2. 在兼容现有生态前提下，输出更高质量机会。
3. 为后续 SSP 化沉淀标准与能力资产。

### 1.2 模块边界

Mediation 负责：
1. 标准接入框架设计。
2. 外部输入到内部统一模型映射。
3. 多供给源适配与统一回传语义。
4. 基础 placement 编排与路由。
5. 请求-事件闭环基础能力。

Mediation 当前不负责：
1. 完整 SSP 交易层。
2. 完整 DSP 决策层。
3. 高复杂竞价与全量风控。

## 2. 策略层与关键 Context

### 2.1 当前 Context

1. 冷启动阶段，应用方与广告商数量有限。
2. 早期难以直接规模接入 DSP 与大型 Ads Network。
3. 现阶段供给以广告联盟 + 模拟广告库为主。

### 2.2 为什么是 Mediation First

1. 先解决“接得上、跑得通”。
2. 用统一模型避免后续 SSP 阶段返工。
3. 先做稳定闭环，再扩展复杂能力。

### 2.3 Fundamental Design Principles

1. 单入口：应用只接 Mediation。
2. 单模型：外部输入统一到内部机会模型。
3. 单语义：对应用输出统一响应语义。
4. 双链路：请求同步、事件异步，主链路 fail-open。
5. 可演进：结构必须可平滑升级到 SSP 能力。

## 3. 当前版本具体设计

## 3.1 标准接入框架（Standard Integration Framework）

当前版本接入框架分四个接口面：
1. `Input Interface`：请求接入面。
2. `Delivery Interface`：响应输出面。
3. `Event Interface`：事件回传面。
4. `Control Interface`：运行控制面（开关/降级/回滚）。

当前版本最小流程：
1. 应用同步请求进入统一入口。
2. Mediation 规范化 + 映射 + 编排 + 路由。
3. 返回统一响应（Delivery）。
4. 应用异步回传事件（Event Callback）。
5. 平台完成关联归档与审计。

## 3.2 统一机会建模的数据标准 Schema

这是当前版本的核心标准，不追求一次定义全部字段，而是先冻结稳定“语义骨架”。

### 3.2.1 Schema 目标与重要性

1. 统一“机会对象”定义，跨供给源语义一致。
2. 兼容旧 SSP 必要输入语义。
3. 支持 AI Native 增量语义。
4. 可版本化与可演进。
5. 作为 Mediation 的共同语言，保证后续路由、回传、闭环不发散。

### 3.2.2 六块 Schema 骨架

1. `RequestMeta`：请求级元信息。
2. `PlacementMeta`：广告位与触发信息。
3. `UserContext`：用户与会话上下文。
4. `OpportunityContext`：当前机会语义（任务阶段/触发意图/交互状态）。
5. `PolicyContext`：策略与约束上下文。
6. `TraceContext`：追踪与排查上下文。

### 3.2.3 当前版本冻结范围：每块 required/optional

当前版本不追求字段完备，而是先冻结六块结构和每块的 required/optional 边界。

1. `RequestMeta`
   - required：请求身份、应用来源、接入时间、接入通道。
   - optional：SDK 能力声明、调试标记、请求补充标签。
2. `PlacementMeta`
   - required：placement 身份、触发位置、触发时机。
   - optional：展示偏好、格式偏好、实验分桶信息。
3. `UserContext`
   - required：会话维度的最小主体信息（匿名可接受）。
   - optional：历史偏好、细分画像、跨会话补充上下文。
4. `OpportunityContext`
   - required：当前机会类型、链路阶段、触发意图快照。
   - optional：任务细粒度阶段、上下游依赖信号、扩展语义标签。
5. `PolicyContext`
   - required：合规约束、频控约束、业务硬约束。
   - optional：策略实验参数、柔性优先级、供给偏好规则。
6. `TraceContext`
   - required：请求追踪主键、链路追踪信息、关联引用。
   - optional：诊断扩展、灰度标记、问题复现上下文。

### 3.2.4 当前版本最小语义统一范围

1. 请求与会话是谁、在何时何处发生。
2. placement 在什么应用链路阶段触发。
3. 当前交互主体与机会上下文是什么。
4. 这次机会受哪些策略约束。
5. 如何被追踪、回放与审计。

### 3.2.5 版本与状态机（当前版本冻结）

当前版本在机会对象顶层冻结两个控制语义：`schemaVersion` 与 `state`。

1. `schemaVersion`
   - required，表示对象遵循的标准版本。
   - 当前版本规则：新能力先走 optional；破坏兼容时才升级主版本。
2. `state`
   - 枚举固定为：`received` / `routed` / `served` / `no_fill` / `error`。
   - 语义：
     - `received`：请求已接收并完成基础规范化。
     - `routed`：已完成路由决策并进入供给调用。
     - `served`：已有有效返回并输出给应用。
     - `no_fill`：流程正常结束但无可返回候选。
     - `error`：流程异常结束（可重试或不可重试）。
   - 状态迁移约束：
     - 起始状态固定 `received`。
     - 终态固定 `served` / `no_fill` / `error`。
     - 任一迁移都必须记录时间戳与原因码，用于闭环审计。

## 3.3 外部输入到内部统一模型的映射规则

### 3.3.1 外部输入分层

外部输入拆分为五类：
1. 应用与会话信息。
2. placement 与触发信息。
3. 用户与内容上下文。
4. 策略与限制信息。
5. 追踪与诊断信息。

### 3.3.2 映射原则与重要性

1. 先映射后决策：先进入统一模型再路由。
2. 缺失关键输入时走受控降级，不阻断主链路。
3. 枚举归一：外部枚举映射到内部标准枚举。
4. 冲突归一：多来源冲突按优先级归一。
5. 结果可回放：映射结果可复现、可审计。
6. 同请求同结果：同一输入条件下映射结果必须确定性一致。

重要性：
1. 外部输入来源多且异构，不先定义冲突优先级会出现同请求多结果。
2. 映射链路不可回放会导致问题无法定位，也无法支撑后续优化。
3. 映射不稳定会直接污染路由、回传和闭环统计口径。

### 3.3.3 来源优先级与冲突处理（当前版本冻结）

当前版本先冻结跨模块通用优先级，避免不同接入方各自解释。

统一优先级（高 -> 低）：
1. 应用显式输入（App Explicit）。
2. placement 配置（Placement Config）。
3. 平台默认策略（Default Policy）。

冲突处理约束：
1. 同一语义位点只允许一个最终生效值。
2. 低优先级来源不得覆盖高优先级来源。
3. 若同级来源冲突，按稳定决策键（如规则版本 + 来源顺序）做确定性裁决。
4. 冲突裁决必须输出标准原因码，供审计与复现。

### 3.3.4 枚举归一规范（当前版本最小集）

1. 建立统一枚举字典，外部枚举必须先映射再进入内部模型。
2. 不认识的外部枚举进入受控兜底值（如 `unknown`），禁止直接透传污染内部语义。
3. 枚举升级通过版本化管理，确保新旧接入兼容。
4. 归一规则由适配层吸收，内部模型只消费标准枚举。

### 3.3.5 映射审计记录（可回放）

每次映射都必须沉淀最小审计记录，至少包含：
1. 原始来源与原始值（raw source + raw value）。
2. 归一后的标准值（normalized value）。
3. 冲突处理动作与原因码（resolution action + reason code）。
4. 生效规则版本（mapping rule version）。
5. 处理时间与追踪关联（timestamp + trace reference）。

### 3.3.6 映射治理

1. 映射规则版本化。
2. 映射失败与冲突处理语义标准化。
3. 外部协议变化通过适配层吸收，不直接污染内部模型。

## 3.4 两种供给源最小适配与回传 Schema

### 3.4.1 两类供给源（当前版本）

1. 广告联盟供给源。
2. 模拟广告库供给源。

### 3.4.2 Supply Adapter 标准合同（当前版本冻结）

重要性：
1. 没有统一 Adapter 合同，就无法低成本接入更多供给源。
2. 不同 Adapter 若各自实现，会导致质量不可控、行为不可复现。
3. 合同先统一，后续扩供给只需“按合同接入”，不改主链路语义。

每个 Adapter 至少实现四件事：
1. `request adapt`：外部请求语义 -> 内部统一请求语义。
2. `candidate normalize`：外部返回候选 -> 内部统一候选语义。
3. `error normalize`：外部失败/超时/空返回 -> 平台统一错误与状态语义。
4. `source trace`：保留来源标识、调用轨迹、诊断上下文，支撑审计与排障。

合同边界约束：
1. 主语义字段只能写入统一模型定义的标准位点。
2. 外部私有字段统一进入 `extensions`，不得污染主语义。
3. `extensions` 只做补充信息承载，不参与核心路由判定与闭环口径定义。
4. 同类输入在同规则版本下必须得到确定性一致输出。

### 3.4.3 Adapter 最小交付检查（当前版本）

1. 能完成请求适配并通过标准模型校验。
2. 能输出统一候选并通过候选语义校验。
3. 能把外部错误映射为标准状态与原因码。
4. 能输出最小追踪信息并与 `TraceContext` 关联。
5. 私有字段仅出现在 `extensions`，无主语义污染。

### 3.4.4 回传 Schema 冲突（你指出的核心问题）

冲突主要来自：
1. 响应 Schema 与事件回传 Schema 混用。
2. 供给私有追踪字段与平台统一追踪字段冲突。
3. 返回时序与事件时序不一致造成关联困难。

### 3.4.5 Delivery / Event 分离设计（Fundamental Design）

重要性：
1. 当前核心冲突就来自“返回”和“回传”耦合，不分离会导致语义错位。
2. 结算与归因依赖事件链路，若与返回混用会导致口径不一致。
3. 分离后可保证主链路稳定返回，异步链路独立演进。

当前版本采用“两个 Schema + 一个关联引用”：
1. `Delivery Schema`：只表达本次返回结果，不承载后续行为语义。
2. `Event Callback Schema`：只表达后续行为事件，不重复承载完整返回内容。
3. `responseReference`：请求-返回-事件的统一关联主键。

职责边界：
1. Delivery 负责“本次给了什么、给谁、处于什么返回状态”。
2. Event 负责“后续发生了什么行为、发生时间、行为结果”。
3. Delivery 与 Event 必须通过同一个 `responseReference` 关联到同一机会记录。
4. 私有字段若需保留，进入 `extensions`，不得改变主语义职责边界。

### 3.4.6 responseReference 与事件最小集（当前版本冻结）

1. `responseReference` 是 Delivery/Event 关联必填项，缺失时事件不得进入标准闭环口径。
2. Event 最小集先冻结为：`impression` / `click` / `failure`。
3. 所有最小事件都必须携带：事件类型、事件时间、`responseReference`、标准状态与原因码（如适用）。
4. 新增事件类型采用版本化扩展，不得破坏最小集语义。

验收基线：
1. Delivery 在不依赖事件回传成功的情况下可独立完成返回。
2. Event 在不重复 Delivery 负载的情况下可独立完成行为上报。
3. 任一 `impression`/`click`/`failure` 事件都能通过 `responseReference` 回溯到单次返回记录。

## 3.5 数据闭环实现（Data Loop）

### 3.5.1 闭环目标与重要性

1. 形成 `Request -> Delivery -> Event -> Archive` 的最小闭环。
2. 为优化策略、质量评估、SSP 过渡提供稳定数据基础。
3. 没有闭环就无法形成可验证、可迭代的系统能力。

### 3.5.2 闭环标准模型（当前版本）

1. `Request`：请求进入后完成规范化、映射与追踪标识初始化。
2. `Delivery`：记录本次返回快照、返回状态、`responseReference`。
3. `Event`：接收并归一后续行为事件（`impression` / `click` / `failure`）。
4. `Archive`：按关联键汇聚为单机会记录，沉淀时间线与审计信息。

### 3.5.3 机会对象可追溯约束（当前版本冻结）

1. 每个机会对象必须具备可关联的追踪主键与 `responseReference`。
2. 每个链路节点都必须记录时间戳、状态、原因码。
3. 映射与路由决策必须记录规则版本，确保可复现。
4. 缺失关键关联键的数据进入隔离轨道，不进入标准闭环口径。

### 3.5.4 闭环完成条件（当前版本冻结）

1. 存在有效 Delivery 记录（返回状态为 `served` / `no_fill` / `error` 之一）。
2. 存在终态 Event（当前最小终态集合：`impression` / `click` / `failure`）。
3. Delivery 与终态 Event 必须由同一个 `responseReference` 关联。
4. 事件窗口超时仍无终态 Event 时，系统写入 `failure` 终态（超时原因）完成闭环。

### 3.5.5 单请求全链路回放（当前版本基线）

1. 以 `responseReference` 或追踪主键可回放单请求全链路。
2. 回放输出至少覆盖：请求输入、映射结果、路由决策、Delivery、Event、Archive。
3. 回放结果必须可解释同请求为何得到当前结果。
4. 回放能力优先服务排障、对账与策略迭代，不影响线上主链路可用性。

## 3.6 旧 SSP 内容与新增 AI 内容（Old vs New）

这是当前版本对接设计中必须显式说明的边界。

### 3.6.1 旧 SSP 必含内容（必须兼容）

1. 基础请求语义（应用/会话/请求上下文）。
2. placement 与展示语义。
3. 基础环境与内容语义。
4. 基础响应与基础回传语义。

### 3.6.2 新增 AI 内容（当前版本增量）

1. Workflow 阶段语义。
2. 交互主体语义（人类/Agent）。
3. 机会意图快照语义。
4. 任务上下文最小语义。

### 3.6.3 对接策略

1. 先保证旧语义可完整对接。
2. 新语义采用“增强不破坏”策略逐步附加。
3. 外部网络不支持的新语义由 Mediation 内部沉淀并用于后续升级。

## 3.7 最小输入接入指南与最小链路清单

### 3.7.1 最小输入接入指南（SDK 风格）

1. 注册应用与 placement 基础信息。
2. 接入同步请求入口。
3. 接入统一响应处理与 fail-open。
4. 接入异步事件回传入口。
5. 完成联调与发布前检查。

### 3.7.2 最小链路清单（当前版本）

请求链路（同步）：
1. 请求进入统一入口。
2. 输入规范化与模型映射。
3. placement 编排与供给路由。
4. 适配器调用与结果归一。
5. 输出统一响应并记录追踪上下文。

事件链路（异步）：
1. 曝光/点击/失败事件上报。
2. 事件规范化与关联。
3. 归档与审计写入。
4. 返回事件处理状态。

## 3.8 路由与降级策略模型（当前版本）

### 3.8.1 目标与重要性

1. 这是当前版本真实可用性的核心，不先定策略线上行为会不稳定。
2. 在供给不稳定、延迟波动、冷启动样本少的阶段，路由与降级必须优先可控。
3. 当前版本先保证确定性与可运维，再考虑复杂优化器。

### 3.8.2 路由引擎形态：规则 DAG（当前版本冻结）

1. 当前版本使用规则 DAG，不引入复杂优化器。
2. 每个节点只做单一判定：准入、约束过滤、路由选择、降级决策。
3. DAG 节点结果必须可解释，并记录规则版本与命中原因。
4. 任一请求在同输入与同规则版本下必须得到确定性一致路由结果。

### 3.8.3 主路由 / 次路由 / fallback 顺序（当前版本冻结）

1. 主路由（Primary）：优先尝试首选供给源。
2. 次路由（Secondary）：主路由失败或不满足约束后按顺序尝试备选供给源。
3. fallback（兜底）：当主/次路由均不可用时进入兜底供给（如模拟广告库）。
4. 顺序约束：`Primary -> Secondary -> Fallback`，不得跳级逆序执行。
5. 每次路由切换都必须记录切换原因（no-fill、timeout、error、policy block）。

### 3.8.4 超时阈值与 no-fill 处理（当前版本冻结）

1. 为每条供给调用定义超时阈值（按 placement 类别配置）。
2. 超时即视为标准错误并触发下一路由，不阻塞主链路。
3. `no_fill` 定义为流程正常结束但无可返回候选，不等同于系统错误。
4. `error` 定义为调用或处理异常，可按可重试/不可重试分类。
5. `no_fill` 与 `error` 都必须进入统一状态机与闭环归档口径。

### 3.8.5 降级策略与可用性边界（当前版本）

1. 主链路默认 fail-open：路由失败时优先返回可接受兜底结果。
2. 当命中强合规/强策略约束时允许 fail-closed，直接返回受控空结果。
3. 降级动作分层：降路由复杂度 -> 切备源 -> 走兜底源 -> 受控 no-fill。
4. 每次降级必须记录触发条件、执行路径、最终状态，支撑回放与审计。

### 3.8.6 验收基线

1. 能在规则 DAG 下稳定执行主次路由并输出确定性结果。
2. 超时、no-fill、error 三类场景都能触发预期 fallback 顺序。
3. fail-open 与 fail-closed 边界明确且可配置。
4. 任一路由决策都可通过追踪信息回放到规则节点级别。

## 3.9 可观测与审计模型（当前版本）

### 3.9.1 目标与重要性

1. 可观测与审计是排障效率和运营可控性的基础能力。
2. 没有标准审计模型，线上异常无法快速定位，策略效果也无法复盘。
3. 当前版本先保证“看得见、查得到、能复放”，再扩展更复杂分析能力。

### 3.9.2 最小审计单元：单机会对象（当前版本冻结）

1. 审计最小粒度固定为“单机会对象（single opportunity object）”。
2. 单机会对象必须通过追踪主键与 `responseReference` 唯一关联。
3. 审计记录必须覆盖对象全生命周期，不允许只记录局部片段。
4. 缺失关键关联键的记录进入隔离区，不进入标准统计口径。

### 3.9.3 四段关键决策点（当前版本冻结）

单机会对象必须沉淀四段关键决策点：

1. `Mapping`（映射决策点）：
   - 记录输入来源、归一结果、冲突裁决、规则版本。
2. `Routing`（路由决策点）：
   - 记录命中节点、主次路由选择、fallback 原因、超时信息。
3. `Delivery`（返回决策点）：
   - 记录返回状态（`served`/`no_fill`/`error`）、返回快照、输出时间。
4. `Event`（回传决策点）：
   - 记录事件类型（最小集 `impression`/`click`/`failure`）、事件状态、关联结果。

### 3.9.4 审计记录最小字段集（当前版本）

每个决策点都必须至少记录：

1. 决策点类型（mapping/routing/delivery/event）。
2. 决策时间戳与处理耗时。
3. 输入摘要与输出摘要。
4. 状态与原因码。
5. 生效规则版本。
6. 关联键（trace key + `responseReference`）。

### 3.9.5 可观测视图与运维闭环（当前版本）

1. 请求级视图：单请求全链路时间线（mapping -> routing -> delivery -> event -> archive）。
2. 状态级视图：`served`/`no_fill`/`error` 分布与变化趋势。
3. 原因级视图：超时、策略拦截、无候选、适配失败等原因码聚合。
4. 供给级视图：按供给源统计延迟、成功率、no-fill 率、error 率。

### 3.9.6 验收基线

1. 任一线上请求都能按单机会对象回放四段关键决策点。
2. 关键状态与原因码可在分钟级检索并用于排障。
3. 运营可按 placement、供给源、状态进行稳定对账。
4. 审计写入不得阻塞主链路，失败时走异步补偿。

## 3.10 配置与版本治理（当前版本）

### 3.10.1 目标与重要性

1. 没有版本治理，迭代会频繁破坏接入方稳定性。
2. 当前版本需要在“快速迭代”和“兼容稳定”之间建立可执行边界。
3. 版本治理是跨团队协同、灰度发布、回滚止损的前置能力。

### 3.10.2 三条版本线分离管理（当前版本冻结）

当前版本固定三条版本线，禁止混用：

1. `Schema Version`
   - 管理统一机会模型结构与语义（六块模型、状态机、Delivery/Event 语义）。
2. `Routing Strategy Version`
   - 管理规则 DAG、路由顺序、超时阈值、降级与 fallback 策略。
3. `Placement Config Version`
   - 管理 placement 级触发条件、频控/冷却、展示约束、策略参数。

治理约束：
1. 三条版本线独立发布、独立回滚、独立审计。
2. 任一线升级不得隐式修改其他两线行为。
3. 单请求必须记录三线生效版本，保证可复现。

### 3.10.3 兼容性与发布规则（当前版本）

1. `Schema Version`：
   - 向后兼容变更优先走 optional 扩展。
   - 破坏兼容才允许主版本升级，并提供迁移窗口。
2. `Routing Strategy Version`：
   - 变更需先灰度到受控流量，再逐步放量。
   - 放量过程必须监控 `served/no_fill/error` 与延迟指标。
3. `Placement Config Version`：
   - 以 placement 为粒度灰度，不做全量硬切。
   - 配置发布必须附带默认值与回退值。

### 3.10.4 版本绑定与回滚策略（当前版本冻结）

1. 每次线上请求都必须写入版本快照：
   - `schemaVersion`
   - `routingStrategyVersion`
   - `placementConfigVersion`
2. 问题处置优先按“最小影响面”回滚：
   - 先回滚 placement 配置。
   - 再回滚路由策略。
   - 最后才回滚 schema 版本。
3. 回滚必须保留前后版本对比与原因码，纳入审计。

### 3.10.5 验收基线

1. 三条版本线可独立升级与独立回滚，不互相阻塞。
2. 任一异常请求可定位到三条线具体生效版本。
3. 接入方在 schema 不破坏兼容时无需改造即可继续运行。
4. 发布失败可在可控时间内完成降级或回滚。

## 4. 当前版本交付包（Deliverables）

1. 标准接入框架说明。
2. 统一机会建模 Schema 说明。
3. 外部输入映射规则说明。
4. 两类供给适配说明。
5. 回传 Schema 边界说明（Delivery vs Event Callback）。
6. 数据闭环说明。
7. 旧 SSP vs 新 AI 内容边界说明。
8. 最小接入指南与最小链路清单。
9. 联调与发布检查清单。
10. 路由与降级策略模型说明（规则 DAG + fallback 顺序 + 阈值策略）。
11. 可观测与审计模型说明（单机会对象 + 四段关键决策点）。
12. 配置与版本治理说明（三线分离：schema/route/placement）。

## 5. 优化项与 SSP 过渡（Plan）

### 5.1 优化项：编排与路由扩展

1. 扩展 placement 类型与场景覆盖。
2. 扩展供给路由和回退策略。
3. 在不破坏当前版本标准前提下提升匹配效率。

### 5.2 优化项：返回与回传能力增强

1. 扩展回传事件体系与追踪能力。
2. 强化可观测与审计体系。
3. 为 SSP 过渡准备更完整信号输出结构。

### 5.3 标准化交易接口与 SSP 过渡

1. 把当前稳定能力模块化产品化。
2. 将流量质量、机会分析、意图识别、用户建模逐步升级到 SSP 能力。

#### 5.3.1 标准化交易接口目标（SSP Transition）

1. 将当前 Mediation 的“机会编排接口”升级为“可交易接口”。
2. 对外提供可被 DSP/Ads Network 稳定消费的标准请求、标准回传、标准结算语义。
3. 在兼容旧 SSP 输入标准的同时，输出 AI 场景增量信号，形成差异化质量资产。

#### 5.3.2 交易接口分层（建议标准）

向 SSP 过渡时，接口建议拆成六层并独立版本化：

1. `Bid Opportunity Interface`（请求接口）：
   - 表达可交易机会、上下文、策略约束、时延预算。
2. `Bid Decision Interface`（响应接口）：
   - 表达出价、素材候选、有效期、响应状态与拒绝原因。
3. `Auction Result Interface`（结果通知接口）：
   - 表达中标/未中标、价格结果、清算依据、结果时间。
4. `Delivery Callback Interface`（交付回传接口）：
   - 表达交付状态与展示确认，不承载行为转化语义。
5. `Event Callback Interface`（行为事件接口）：
   - 表达 `impression/click/failure` 最小闭环事件及扩展事件。
6. `Settlement & Reconciliation Interface`（结算对账接口）：
   - 表达账单口径、分润规则、对账批次、差异处理状态。

#### 5.3.3 信息采集层面需要补充的关键项

当前版本已有基础闭环，但向 SSP 过渡仍需补强以下采集维度：

1. 交易上下文信号：
   - `auction_type`、`pricing_model`、`currency`、`floor_policy_snapshot`、`timeout_budget`。
2. 供给路径信号：
   - `source_path`、`adapter_hop`、`fallback_path`、`path_latency_breakdown`。
3. 质量与可见性信号：
   - `view_opportunity_level`、`placement_quality_tier`、`traffic_quality_flags`。
4. 交互与任务信号：
   - `workflow_stage`、`agent_or_human_actor`、`intent_confidence_band`。
5. 结算与对账信号：
   - `settlement_reference`、`billing_scope`、`reconciliation_batch_id`、`dispute_reason`。
6. 合规与授权信号：
   - `consent_scope`、`policy_decision_code`、`restricted_category_flags`。

#### 5.3.4 Schema 层面增补建议（按六块模型）

保持六块统一模型不变，向 SSP 过渡时以“子结构扩展 + optional 字段”方式增强：

1. `RequestMeta` 增补：
   - `transactionContext`（auction/pricing/currency/timeout）。
   - `requestSLA`（tmax、重试预算、降级预算）。
2. `PlacementMeta` 增补：
   - `placementQualityProfile`（quality tier、view opportunity、历史稳定性）。
   - `commercialConstraintProfile`（频控档位、展示密度约束）。
3. `UserContext` 增补：
   - `interactionRole`（human/agent/agent-chain）。
   - `sessionIntentWindow`（多轮意图窗口摘要与置信区间）。
4. `OpportunityContext` 增补：
   - `marketabilitySignals`（可交易性标签、推荐可解释信号）。
   - `executionStageSignals`（任务执行阶段与转化窗口）。
5. `PolicyContext` 增补：
   - `complianceSnapshot`（授权范围、敏感类目策略快照）。
   - `pricingGuardrail`（价格底线策略与策略命中原因）。
6. `TraceContext` 增补：
   - `auctionReference`、`settlementReference`、`reconciliationReference`。
   - `decisionLineage`（映射/路由/拍卖/结算的版本链路）。

#### 5.3.5 当前缺口识别（Collection + Schema）

1. 缺少交易级上下文快照：
   - 当前侧重机会与回传，交易参数采集不完整。
2. 缺少供给路径可解释性：
   - 现有 trace 可回放，但未标准化供给路径拆分指标。
3. 缺少结算级关联键：
   - 已有 `responseReference`，但结算/对账 reference 尚未纳入标准最小集。
4. 缺少质量分层标准：
   - 已有策略与路由，但缺统一的 `placement quality tier` 与 view-opportunity 档位。
5. 缺少接口层分离：
   - Delivery/Event 已分离，但交易结果通知与结算接口仍需单独标准化。

#### 5.3.6 演进落地顺序（建议）

1. Step A（采集与 schema 增强）：
   - 先补齐交易上下文采集与 schema optional 增量，不改变对外兼容。
2. Step B（交易接口灰度）：
   - 引入 `Auction Result Interface` 与 `Settlement/Reconciliation Interface` 草案并灰度。
3. Step C（质量标准化）：
   - 建立质量分层标准与供给路径解释标准，形成可外部消费的质量信号包。
4. Step D（SSP 阶段）：
   - 将六层交易接口版本化发布，提供稳定 SLA 与兼容矩阵。

#### 5.3.7 过渡验收基线

1. 接口层：
   - 六层交易接口都有独立版本与回滚策略。
2. 采集层：
   - 单机会对象可关联到交易、交付、行为、结算四类 reference。
3. Schema 层：
   - 增量字段全部以后向兼容方式引入，接入方无感升级可运行。
4. 运营层：
   - 可对账、可追责、可回放，且能按质量分层输出稳定报表。

## 6. 变更记录

### 2026-02-21（v1.7）

1. 按统一口径去除阶段编号概念，统一为“当前版本 + 优化项”表达。
2. 将“后续规划”重构为“优化项与 SSP 过渡”，避免多套阶段定义并行。
3. 保留原有设计内容与约束，不改变已定义的核心能力边界。

### 2026-02-21（v1.6）

1. 细化 `5.3` 向 SSP 过渡准备，新增标准化交易接口分层蓝图（请求/响应/拍卖结果/回传/结算）。
2. 增加信息采集补强清单，识别交易、供给路径、质量、结算、合规等关键缺口。
3. 增加按六块模型的 schema 增补建议，并给出演进顺序与过渡验收基线。

### 2026-02-21（v1.5）

1. 新增 `3.10` 配置与版本治理，明确其作为稳定迭代与接入兼容的基础能力。
2. 冻结三条版本线分离管理：`schema version`、`routing strategy version`、`placement config version`。
3. 新增兼容性发布规则、版本快照记录、分层回滚策略与验收基线。
4. 在交付包加入配置与版本治理说明。

### 2026-02-21（v1.4）

1. 新增 `3.9` 可观测与审计模型，明确其在排障与运营可控中的基础地位。
2. 冻结“单机会对象”为最小审计单元，并要求全生命周期可追踪。
3. 冻结四段关键决策点：映射、路由、返回、回传。
4. 新增最小审计字段集、可观测视图与验收基线，并加入交付包。

### 2026-02-21（v1.3）

1. 新增关联文档索引，链接回 AI Assistant Placement Framework。
2. 明确 Mediation 设计文档与 placement 产品规范之间的双向对齐关系。

### 2026-02-21（v1.2）

1. 新增 `3.8` 路由与降级策略模型，明确其为当前版本线上可用性核心。
2. 冻结路由引擎形态为规则 DAG，并定义主路由/次路由/fallback 固定顺序。
3. 新增超时阈值、`no_fill` 与 `error` 处理口径，以及 fail-open/fail-closed 边界。
4. 补充路由策略验收基线，并加入交付包清单。

### 2026-02-21（v1.1）

1. 重构 `3.5` 为可判定的数据闭环模型：`Request -> Delivery -> Event -> Archive`。
2. 新增机会对象可追溯约束，要求关键关联键、状态、原因码、规则版本可追踪。
3. 冻结闭环完成条件：有 Delivery 且有终态 Event，并通过同一 `responseReference` 关联。
4. 增加超时兜底终态与单请求全链路回放基线，保障闭环完整性与可排障性。

### 2026-02-21（v1.0）

1. 强化 `3.4.5`：将“回传冲突解决”升级为 Delivery/Event 职责分离设计，并补充重要性说明。
2. 新增 `3.4.6`：冻结 `responseReference` 关联规则与事件最小集（`impression`/`click`/`failure`）。
3. 增加验收基线，确保“返回链路”和“事件链路”解耦且可闭环。

### 2026-02-21（v0.9）

1. 在 `3.4` 新增 “Supply Adapter 标准合同（当前版本冻结）”，明确其作为扩展供给的核心前置条件。
2. 冻结四项必选职责：`request adapt`、`candidate normalize`、`error normalize`、`source trace`。
3. 新增 `extensions` 边界约束：私有字段可保留但不得污染主语义。
4. 新增 Adapter 最小交付检查，作为接入验收基线。

### 2026-02-21（v0.8）

1. 在 `3.3` 补充“输入映射与冲突优先级”的重要性说明，明确其与可复现性的关系。
2. 冻结来源优先级（`app 显式 > placement 配置 > 默认策略`）及冲突裁决约束。
3. 新增枚举归一规范与映射审计记录要求（原值 + 归一值 + 冲突处理 + 规则版本）。

### 2026-02-21（v0.7）

1. 在 `3.2` 明确“统一 Opportunity Schema”的重要性定位（共同语言，避免路由/回传/闭环语义发散）。
2. 冻结六块骨架在当前版本的 required/optional 边界，保持概念层定义。
3. 新增 `schemaVersion` 与 `state`（received/routed/served/no_fill/error）及状态迁移约束。

### 2026-02-21（v0.6）

1. 新增三项核心章节：统一机会建模 Schema、数据闭环、旧 SSP vs 新 AI 内容边界。
2. 将当前版本章节重排为“框架 -> Schema -> 映射 -> 适配 -> 闭环 -> 对接边界 -> 接入清单”。
3. 保留策略分析与优化项规划，避免文档仅剩执行层内容。

### 2026-02-21（v0.5）

1. 重构为“策略 + 上下文 + 当前版本设计 + 后续规划”的一体化设计文档。
