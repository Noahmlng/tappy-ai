# Mediation 模块设计文档（M1 版）

- 文档版本：v1.0
- 最近更新：2026-02-21
- 文档类型：Design Doc（策略分析 + 具体设计 + 演进规划）
- 当前焦点：M1（接入与适配基线）

## 0. 文档定位（Metadata）

本文件同时承载三层信息：
1. 策略与上下文：为什么现在要这么做。
2. M1 具体设计：现在到底怎么做。
3. 未来规划：M2/M3 以及向 SSP 过渡怎么走。

## 1. 模块使命与边界

### 1.1 模块使命

Mediation 的核心使命：
1. 让 AI 应用低成本、低摩擦接入广告网络。
2. 在兼容现有生态前提下，输出更高质量机会。
3. 为后续 SSP 化沉淀标准与能力资产。

### 1.2 模块边界

Mediation 负责：
1. 标准接入框架设计。
2. 外部输入到内部统一模型映射。
3. 多供给源适配与统一回传语义。
4. 基础 placement 编排与路由。
5. 请求-事件闭环基础能力。

Mediation 当前不负责：
1. 完整 SSP 交易层。
2. 完整 DSP 决策层。
3. 高复杂竞价与全量风控。

## 2. 策略层与关键 Context

### 2.1 当前 Context

1. 冷启动阶段，应用方与广告商数量有限。
2. 早期难以直接规模接入 DSP 与大型 Ads Network。
3. 现阶段供给以广告联盟 + 模拟广告库为主。

### 2.2 为什么是 Mediation First

1. 先解决“接得上、跑得通”。
2. 用统一模型避免后续 SSP 阶段返工。
3. 先做稳定闭环，再扩展复杂能力。

### 2.3 Fundamental Design Principles

1. 单入口：应用只接 Mediation。
2. 单模型：外部输入统一到内部机会模型。
3. 单语义：对应用输出统一响应语义。
4. 双链路：请求同步、事件异步，主链路 fail-open。
5. 可演进：M1 结构必须可平滑升级到 M2/M3/SSP。

## 3. M1 具体设计

## 3.1 标准接入框架（Standard Integration Framework）

M1 接入框架分四个接口面：
1. `Input Interface`：请求接入面。
2. `Delivery Interface`：响应输出面。
3. `Event Interface`：事件回传面。
4. `Control Interface`：运行控制面（开关/降级/回滚）。

M1 最小流程：
1. 应用同步请求进入统一入口。
2. Mediation 规范化 + 映射 + 编排 + 路由。
3. 返回统一响应（Delivery）。
4. 应用异步回传事件（Event Callback）。
5. 平台完成关联归档与审计。

## 3.2 统一机会建模的数据标准 Schema

这是 M1 的核心标准，不追求一次定义全部字段，而是先冻结稳定“语义骨架”。

### 3.2.1 Schema 目标与重要性

1. 统一“机会对象”定义，跨供给源语义一致。
2. 兼容旧 SSP 必要输入语义。
3. 支持 AI Native 增量语义。
4. 可版本化与可演进。
5. 作为 Mediation 的共同语言，保证后续路由、回传、闭环不发散。

### 3.2.2 六块 Schema 骨架

1. `RequestMeta`：请求级元信息。
2. `PlacementMeta`：广告位与触发信息。
3. `UserContext`：用户与会话上下文。
4. `OpportunityContext`：当前机会语义（任务阶段/触发意图/交互状态）。
5. `PolicyContext`：策略与约束上下文。
6. `TraceContext`：追踪与排查上下文。

### 3.2.3 M1 冻结范围：每块 required/optional

M1 不追求字段完备，而是先冻结六块结构和每块的 required/optional 边界。

1. `RequestMeta`
   - required：请求身份、应用来源、接入时间、接入通道。
   - optional：SDK 能力声明、调试标记、请求补充标签。
2. `PlacementMeta`
   - required：placement 身份、触发位置、触发时机。
   - optional：展示偏好、格式偏好、实验分桶信息。
3. `UserContext`
   - required：会话维度的最小主体信息（匿名可接受）。
   - optional：历史偏好、细分画像、跨会话补充上下文。
4. `OpportunityContext`
   - required：当前机会类型、链路阶段、触发意图快照。
   - optional：任务细粒度阶段、上下游依赖信号、扩展语义标签。
5. `PolicyContext`
   - required：合规约束、频控约束、业务硬约束。
   - optional：策略实验参数、柔性优先级、供给偏好规则。
6. `TraceContext`
   - required：请求追踪主键、链路追踪信息、关联引用。
   - optional：诊断扩展、灰度标记、问题复现上下文。

### 3.2.4 M1 最小语义统一范围

1. 请求与会话是谁、在何时何处发生。
2. placement 在什么应用链路阶段触发。
3. 当前交互主体与机会上下文是什么。
4. 这次机会受哪些策略约束。
5. 如何被追踪、回放与审计。

### 3.2.5 版本与状态机（M1 冻结）

M1 在机会对象顶层冻结两个控制语义：`schemaVersion` 与 `state`。

1. `schemaVersion`
   - required，表示对象遵循的标准版本。
   - M1 规则：新能力先走 optional；破坏兼容时才升级主版本。
2. `state`
   - 枚举固定为：`received` / `routed` / `served` / `no_fill` / `error`。
   - 语义：
     - `received`：请求已接收并完成基础规范化。
     - `routed`：已完成路由决策并进入供给调用。
     - `served`：已有有效返回并输出给应用。
     - `no_fill`：流程正常结束但无可返回候选。
     - `error`：流程异常结束（可重试或不可重试）。
   - 状态迁移约束：
     - 起始状态固定 `received`。
     - 终态固定 `served` / `no_fill` / `error`。
     - 任一迁移都必须记录时间戳与原因码，用于闭环审计。

## 3.3 外部输入到内部统一模型的映射规则

### 3.3.1 外部输入分层

外部输入拆分为五类：
1. 应用与会话信息。
2. placement 与触发信息。
3. 用户与内容上下文。
4. 策略与限制信息。
5. 追踪与诊断信息。

### 3.3.2 映射原则与重要性

1. 先映射后决策：先进入统一模型再路由。
2. 缺失关键输入时走受控降级，不阻断主链路。
3. 枚举归一：外部枚举映射到内部标准枚举。
4. 冲突归一：多来源冲突按优先级归一。
5. 结果可回放：映射结果可复现、可审计。
6. 同请求同结果：同一输入条件下映射结果必须确定性一致。

重要性：
1. 外部输入来源多且异构，不先定义冲突优先级会出现同请求多结果。
2. 映射链路不可回放会导致问题无法定位，也无法支撑后续优化。
3. 映射不稳定会直接污染路由、回传和闭环统计口径。

### 3.3.3 来源优先级与冲突处理（M1 冻结）

M1 先冻结跨模块通用优先级，避免不同接入方各自解释。

统一优先级（高 -> 低）：
1. 应用显式输入（App Explicit）。
2. placement 配置（Placement Config）。
3. 平台默认策略（Default Policy）。

冲突处理约束：
1. 同一语义位点只允许一个最终生效值。
2. 低优先级来源不得覆盖高优先级来源。
3. 若同级来源冲突，按稳定决策键（如规则版本 + 来源顺序）做确定性裁决。
4. 冲突裁决必须输出标准原因码，供审计与复现。

### 3.3.4 枚举归一规范（M1 最小集）

1. 建立统一枚举字典，外部枚举必须先映射再进入内部模型。
2. 不认识的外部枚举进入受控兜底值（如 `unknown`），禁止直接透传污染内部语义。
3. 枚举升级通过版本化管理，确保新旧接入兼容。
4. 归一规则由适配层吸收，内部模型只消费标准枚举。

### 3.3.5 映射审计记录（可回放）

每次映射都必须沉淀最小审计记录，至少包含：
1. 原始来源与原始值（raw source + raw value）。
2. 归一后的标准值（normalized value）。
3. 冲突处理动作与原因码（resolution action + reason code）。
4. 生效规则版本（mapping rule version）。
5. 处理时间与追踪关联（timestamp + trace reference）。

### 3.3.6 映射治理

1. 映射规则版本化。
2. 映射失败与冲突处理语义标准化。
3. 外部协议变化通过适配层吸收，不直接污染内部模型。

## 3.4 两种供给源最小适配与回传 Schema

### 3.4.1 两类供给源（M1）

1. 广告联盟供给源。
2. 模拟广告库供给源。

### 3.4.2 Supply Adapter 标准合同（M1 冻结）

重要性：
1. 没有统一 Adapter 合同，就无法低成本接入更多供给源。
2. 不同 Adapter 若各自实现，会导致质量不可控、行为不可复现。
3. 合同先统一，后续扩供给只需“按合同接入”，不改主链路语义。

每个 Adapter 至少实现四件事：
1. `request adapt`：外部请求语义 -> 内部统一请求语义。
2. `candidate normalize`：外部返回候选 -> 内部统一候选语义。
3. `error normalize`：外部失败/超时/空返回 -> 平台统一错误与状态语义。
4. `source trace`：保留来源标识、调用轨迹、诊断上下文，支撑审计与排障。

合同边界约束：
1. 主语义字段只能写入统一模型定义的标准位点。
2. 外部私有字段统一进入 `extensions`，不得污染主语义。
3. `extensions` 只做补充信息承载，不参与核心路由判定与闭环口径定义。
4. 同类输入在同规则版本下必须得到确定性一致输出。

### 3.4.3 Adapter 最小交付检查（M1）

1. 能完成请求适配并通过标准模型校验。
2. 能输出统一候选并通过候选语义校验。
3. 能把外部错误映射为标准状态与原因码。
4. 能输出最小追踪信息并与 `TraceContext` 关联。
5. 私有字段仅出现在 `extensions`，无主语义污染。

### 3.4.4 回传 Schema 冲突（你指出的核心问题）

冲突主要来自：
1. 响应 Schema 与事件回传 Schema 混用。
2. 供给私有追踪字段与平台统一追踪字段冲突。
3. 返回时序与事件时序不一致造成关联困难。

### 3.4.5 Delivery / Event 分离设计（Fundamental Design）

重要性：
1. 当前核心冲突就来自“返回”和“回传”耦合，不分离会导致语义错位。
2. 结算与归因依赖事件链路，若与返回混用会导致口径不一致。
3. 分离后可保证主链路稳定返回，异步链路独立演进。

M1 采用“两个 Schema + 一个关联引用”：
1. `Delivery Schema`：只表达本次返回结果，不承载后续行为语义。
2. `Event Callback Schema`：只表达后续行为事件，不重复承载完整返回内容。
3. `responseReference`：请求-返回-事件的统一关联主键。

职责边界：
1. Delivery 负责“本次给了什么、给谁、处于什么返回状态”。
2. Event 负责“后续发生了什么行为、发生时间、行为结果”。
3. Delivery 与 Event 必须通过同一个 `responseReference` 关联到同一机会记录。
4. 私有字段若需保留，进入 `extensions`，不得改变主语义职责边界。

### 3.4.6 responseReference 与事件最小集（M1 冻结）

1. `responseReference` 是 Delivery/Event 关联必填项，缺失时事件不得进入标准闭环口径。
2. Event 最小集先冻结为：`impression` / `click` / `failure`。
3. 所有最小事件都必须携带：事件类型、事件时间、`responseReference`、标准状态与原因码（如适用）。
4. 新增事件类型采用版本化扩展，不得破坏最小集语义。

M1 验收基线：
1. Delivery 在不依赖事件回传成功的情况下可独立完成返回。
2. Event 在不重复 Delivery 负载的情况下可独立完成行为上报。
3. 任一 `impression`/`click`/`failure` 事件都能通过 `responseReference` 回溯到单次返回记录。

## 3.5 数据闭环实现（Data Loop）

### 3.5.1 闭环目标

1. 形成请求 -> 响应 -> 事件 -> 归档的最小闭环。
2. 让策略迭代与后续 SSP 升级有稳定数据基础。

### 3.5.2 闭环链路

1. 请求进入并完成模型映射。
2. 路由与返回结果写入请求侧轨迹。
3. 曝光/点击/失败事件回传并关联。
4. 按关联引用汇聚为“单机会闭环记录”。

### 3.5.3 闭环基础能力

1. 关联能力：请求、响应、事件同源可追踪。
2. 对账能力：响应状态与事件状态可核对。
3. 追溯能力：异常可回放到映射和路由阶段。
4. 演进能力：闭环输出可直接反哺 M2/M3。

## 3.6 旧 SSP 内容与新增 AI 内容（Old vs New）

这是 M1 对接设计中必须显式说明的边界。

### 3.6.1 旧 SSP 必含内容（必须兼容）

1. 基础请求语义（应用/会话/请求上下文）。
2. placement 与展示语义。
3. 基础环境与内容语义。
4. 基础响应与基础回传语义。

### 3.6.2 新增 AI 内容（M1 增量）

1. Workflow 阶段语义。
2. 交互主体语义（人类/Agent）。
3. 机会意图快照语义。
4. 任务上下文最小语义。

### 3.6.3 对接策略

1. 先保证旧语义可完整对接。
2. 新语义采用“增强不破坏”策略逐步附加。
3. 外部网络不支持的新语义由 Mediation 内部沉淀并用于后续升级。

## 3.7 最小输入接入指南与最小链路清单

### 3.7.1 最小输入接入指南（SDK 风格）

1. 注册应用与 placement 基础信息。
2. 接入同步请求入口。
3. 接入统一响应处理与 fail-open。
4. 接入异步事件回传入口。
5. 完成联调与发布前检查。

### 3.7.2 最小链路清单（M1）

请求链路（同步）：
1. 请求进入统一入口。
2. 输入规范化与模型映射。
3. placement 编排与供给路由。
4. 适配器调用与结果归一。
5. 输出统一响应并记录追踪上下文。

事件链路（异步）：
1. 曝光/点击/失败事件上报。
2. 事件规范化与关联。
3. 归档与审计写入。
4. 返回事件处理状态。

## 4. M1 交付包（Deliverables）

1. 标准接入框架说明。
2. 统一机会建模 Schema 说明。
3. 外部输入映射规则说明。
4. 两类供给适配说明。
5. 回传 Schema 边界说明（Delivery vs Event Callback）。
6. 数据闭环说明。
7. 旧 SSP vs 新 AI 内容边界说明。
8. 最小接入指南与最小链路清单。
9. 联调与发布检查清单。

## 5. 后续规划（Plan）

### 5.1 M2：编排与路由扩展

1. 扩展 placement 类型与场景覆盖。
2. 扩展供给路由和回退策略。
3. 在不破坏 M1 标准前提下提升匹配效率。

### 5.2 M3：返回与回传能力增强

1. 扩展回传事件体系与追踪能力。
2. 强化可观测与审计体系。
3. 为 SSP 过渡准备更完整信号输出结构。

### 5.3 向 SSP 过渡准备

1. 把 M1/M2/M3 稳定能力模块化产品化。
2. 将流量质量、机会分析、意图识别、用户建模逐步升级到 SSP 能力。

## 6. 变更记录

### 2026-02-21（v1.0）

1. 强化 `3.4.5`：将“回传冲突解决”升级为 Delivery/Event 职责分离设计，并补充重要性说明。
2. 新增 `3.4.6`：冻结 `responseReference` 关联规则与事件最小集（`impression`/`click`/`failure`）。
3. 增加 M1 验收基线，确保“返回链路”和“事件链路”解耦且可闭环。

### 2026-02-21（v0.9）

1. 在 `3.4` 新增 “Supply Adapter 标准合同（M1 冻结）”，明确其作为扩展供给的核心前置条件。
2. 冻结四项必选职责：`request adapt`、`candidate normalize`、`error normalize`、`source trace`。
3. 新增 `extensions` 边界约束：私有字段可保留但不得污染主语义。
4. 新增 Adapter 最小交付检查，作为接入验收基线。

### 2026-02-21（v0.8）

1. 在 `3.3` 补充“输入映射与冲突优先级”的重要性说明，明确其与可复现性的关系。
2. 冻结来源优先级（`app 显式 > placement 配置 > 默认策略`）及冲突裁决约束。
3. 新增枚举归一规范与映射审计记录要求（原值 + 归一值 + 冲突处理 + 规则版本）。

### 2026-02-21（v0.7）

1. 在 `3.2` 明确“统一 Opportunity Schema”的重要性定位（共同语言，避免路由/回传/闭环语义发散）。
2. 冻结六块骨架在 M1 的 required/optional 边界，保持概念层定义。
3. 新增 `schemaVersion` 与 `state`（received/routed/served/no_fill/error）及状态迁移约束。

### 2026-02-21（v0.6）

1. 新增三项核心章节：统一机会建模 Schema、数据闭环、旧 SSP vs 新 AI 内容边界。
2. 将 M1 章节重排为“框架 -> Schema -> 映射 -> 适配 -> 闭环 -> 对接边界 -> 接入清单”。
3. 保留策略分析与 M2/M3 规划，避免文档仅剩执行层内容。

### 2026-02-21（v0.5）

1. 重构为“策略 + 上下文 + M1 设计 + 后续规划”的一体化设计文档。
