# Mediation 模块设计文档（M1 版）

- 文档版本：v0.5
- 最近更新：2026-02-21
- 文档类型：Design Doc（策略 + 上下文 + 具体设计 + 后续规划）
- 当前设计范围：Mediation v1 的 M1 阶段

## 0. 文档定位（Metadata）

本文件不是纯 Plan，也不是纯执行 checklist，而是统一回答三类问题：
1. 当下模块怎么设计（M1 具体设计）。
2. 为什么这样设计（策略与关键上下文）。
3. 后续怎么演进（M2/M3 规划路径）。

## 1. 模块使命与边界

### 1.1 模块使命

Mediation 的核心使命：
1. 让 AI 应用以低成本、低摩擦接入广告网络。
2. 在兼容现有生态的前提下，输出更高质量的广告机会。
3. 为后续 SSP 化沉淀可复用的标准、策略与信号能力。

### 1.2 模块边界

Mediation 负责：
1. 标准接入框架。
2. 外部输入到内部统一模型的映射。
3. 多供给源适配与统一回传语义。
4. 动态 placement 的基础编排与路由。

Mediation 当前不负责：
1. 完整 SSP 交易能力。
2. 完整 DSP 决策能力。
3. 高复杂度竞价与全量风控系统。

## 2. 关键上下文与策略层分析

### 2.1 当前上下文（Context）

1. 处于冷启动阶段，应用方与广告商规模有限。
2. 早期难以直接大规模接入 DSP 与大型 Ads Network。
3. 现阶段主要供给来自广告联盟 + 模拟广告库。

### 2.2 策略选择（Why Mediation First）

1. 先解“接得上、跑得通”的问题，再解“做得深、做得强”的问题。
2. 先形成统一标准与统一模型，避免后续 SSP 升级时大规模返工。
3. 先把可执行闭环做稳定，再逐步扩展 placement 与供给生态。

### 2.3 设计原则（Fundamental Design Principles）

1. 单入口：应用只接 Mediation，不直连多个外部供给。
2. 单模型：外部多样输入，内部统一语义模型。
3. 单语义：对应用侧输出统一响应语义。
4. 解耦：请求链路与事件链路解耦，主业务链路 fail-open。
5. 可演进：M1 设计必须能无缝过渡到 M2/M3。

## 3. M1 具体设计

## 3.1 标准接入框架

M1 接入框架分四个接口面：
1. `Input Interface`：应用请求接入面。
2. `Delivery Interface`：广告返回面。
3. `Event Interface`：行为事件回传面。
4. `Control Interface`：运行控制面（开关/降级/回滚）。

M1 最小流程：
1. 应用发起同步请求。
2. Mediation 进行规范化 + 路由 + 统一返回。
3. 应用异步回传曝光/点击等事件。
4. Mediation 归档并关联请求与事件上下文。

## 3.2 外部输入 -> 内部统一模型映射规则

### 外部输入分层

M1 将外部输入统一拆分为五类：
1. 应用与会话信息。
2. placement 与触发信息。
3. 用户与内容上下文。
4. 策略与约束信息。
5. 追踪与诊断信息。

### 内部统一模型（逻辑块）

内部统一模型固定为六块：
1. `RequestMeta`
2. `PlacementMeta`
3. `UserContext`
4. `OpportunityContext`
5. `PolicyContext`
6. `TraceContext`

### 映射规则

1. 所有请求先映射，再进入编排与路由。
2. 缺失关键输入时执行受控降级，不直接中断主链路。
3. 外部枚举必须归一到内部标准枚举。
4. 同一语义多来源冲突时，按预设优先级归一。
5. 映射结果必须可复现，支持排查和审计。

## 3.3 两种供给源最小适配（Supply Adapters）

M1 供给源仅包含：
1. 联盟供给源。
2. 模拟广告库供给源。

每个适配器的最小职责：
1. 输入协议适配为内部请求语义。
2. 输出结果归一为内部候选语义。
3. 错误、超时、空结果归一为平台统一状态。
4. 保留必要来源信息用于追踪与诊断。

### 回传 Schema 冲突与解决

你指出的冲突是正确的，核心在“响应与事件边界不清”。M1 解决方式：
1. `Delivery Schema` 只负责本次返回内容。
2. `Event Callback Schema` 只负责后续行为事件。
3. 两者通过同一 `Response Reference` 做关联闭环。

这样处理后：
1. 响应与事件职责清晰，不混用。
2. 供给源私有字段不会污染应用侧统一语义。
3. 后续升级 SSP 时可独立扩展回传标准。

## 3.4 最小输入接入指南 + 最小链路清单

### 最小输入接入指南（SDK 风格）

接入方按以下顺序执行：
1. 注册应用与 placement 基础信息。
2. 对接 Mediation 同步请求入口。
3. 落地统一响应处理与 fail-open 逻辑。
4. 对接事件回传入口（异步）。
5. 完成联调清单并进入发布检查。

### 最小链路清单（M1）

请求链路（同步）：
1. 请求进入统一入口。
2. 输入规范化与模型映射。
3. placement 编排与供给路由。
4. 适配器调用与结果归一。
5. 输出统一响应并记录追踪上下文。

事件链路（异步）：
1. 曝光/点击/失败事件上报。
2. 事件规范化与关联。
3. 事件归档与审计写入。
4. 返回处理状态（成功/可重试/不可重试）。

## 4. M1 执行交付（Deliverables）

1. 标准接入框架说明（接口面 + 最小流程）。
2. 映射规则说明（五类输入 -> 六块统一模型）。
3. 两类供给源适配说明（联盟 + 模拟库）。
4. 回传 Schema 边界说明（Delivery vs Event Callback）。
5. 最小输入接入指南与最小链路清单。
6. 联调与发布前检查清单。

## 5. 后续规划（Plan）

### 5.1 M2：编排与路由扩展

1. 扩展 placement 类型与场景覆盖。
2. 扩展供给路由策略与回退策略。
3. 在不破坏 M1 接入标准前提下提升匹配效率。

### 5.2 M3：返回与回传能力增强

1. 扩展回传事件体系与追踪能力。
2. 形成更稳定的可观测与审计能力。
3. 为 SSP 过渡准备更完整的信号输出结构。

### 5.3 向 SSP 过渡准备

1. 把 M1/M2/M3 的稳定能力产品化。
2. 将流量质量、机会分析、意图识别、用户建模逐步升级为 SSP 能力。

## 6. 变更记录

### 2026-02-21（v0.5）

1. 按最新要求重构为“策略 + 上下文 + M1 设计 + 后续规划”的一体化设计文档。
2. 保留历史阶段信息与未来规划，不再仅保留执行约束。
3. 聚焦四个 M1 核心设计块，并补充 Metadata 与 Fundamental Design 原则。

### 2026-02-21（v0.4）

1. 将文档重构为 M1 执行型设计文档（非路线图）。
2. 明确四个核心内容：接入框架、映射规则、两类供给适配、最小接入指南与链路清单。
3. 针对回传 Schema 冲突给出基础解法：`两个 Schema + 一个关联键`。

### 2026-02-21（v0.3）

1. 将 `M1` 从讨论入口升级为“逐条对接约束清单”。
2. 新增 A~H 八组必须约束，覆盖接入关系、供给、placement、请求、响应、事件、运行控制与治理。
3. 新增 `M1` 交付物清单，作为执行落地基线。
