name: Mediation Release Gate

on:
  pull_request:
    paths:
      - 'apps/**'
      - 'packages/mediation-sdk-contracts/**'
      - 'mediation/**'
      - 'docs/implementation/**'
      - '.github/workflows/mediation-release-gate.yml'
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'packages/mediation-sdk-contracts/**'
      - 'mediation/**'
      - '.github/workflows/mediation-release-gate.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'release or rollback'
        required: true
        default: 'release'
      target_env:
        description: 'dev/staging/preprod/prod'
        required: true
        default: 'staging'
      release_tag:
        description: 'candidate tag or commit sha'
        required: false
        default: ''

jobs:
  gate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SUPABASE_DB_URL_TEST: ${{ secrets.SUPABASE_DB_URL_TEST }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate deploy handlers
        run: |
          node -e "import('./apps/runtime-api/api/[...path].js').then(()=>console.log('runtime handler ok'))"
          node -e "import('./apps/control-plane-api/api/[...path].js').then(()=>console.log('control handler ok'))"

      - name: Validate contracts package
        run: |
          node -e "import('./packages/mediation-sdk-contracts/src/index.js').then((m)=>console.log(m.listSchemaKeys().length))"
          npm pack --workspace @noahmlng/mediation-sdk-contracts --dry-run

      - name: Migration dry run
        run: npm --prefix ./mediation run db:migrate:dry-run

      - name: Detect Supabase test DB env
        id: db-env
        run: |
          if [ -n "${SUPABASE_DB_URL_TEST}" ] || [ -n "${SUPABASE_DB_URL}" ]; then
            echo "has_db_env=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "has_db_env=false" >> "$GITHUB_OUTPUT"
          echo "::warning::SUPABASE_DB_URL_TEST/SUPABASE_DB_URL is not configured in GitHub Secrets. Integration/E2E gates are skipped."

      - name: Functional P0 gate
        if: steps.db-env.outputs.has_db_env == 'true'
        run: npm --prefix ./mediation run test:functional:p0

      - name: Functional P0 fallback (contracts only)
        if: steps.db-env.outputs.has_db_env != 'true'
        run: npm --prefix ./mediation run test:contracts

      - name: E2E gate
        if: steps.db-env.outputs.has_db_env == 'true'
        run: npm --prefix ./mediation run test:e2e

  release-checklist:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'release' }}
    runs-on: ubuntu-latest
    needs:
      - gate
    steps:
      - name: Print release checklist location
        run: |
          echo "Use docs/implementation/release-and-rollback-playbook.md"
          echo "Target env: ${{ github.event.inputs.target_env }}"
          echo "Release tag: ${{ github.event.inputs.release_tag }}"

  rollback-drill:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback' }}
    runs-on: ubuntu-latest
    needs:
      - gate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate rollback drill record
        run: |
          mkdir -p artifacts
          cp docs/implementation/templates/rollback-drill-record.md artifacts/rollback-drill-record.md
          echo "target_env=${{ github.event.inputs.target_env }}" >> artifacts/rollback-context.txt
          echo "release_tag=${{ github.event.inputs.release_tag }}" >> artifacts/rollback-context.txt

      - name: Upload rollback drill artifact
        uses: actions/upload-artifact@v4
        with:
          name: rollback-drill-template
          path: artifacts/
